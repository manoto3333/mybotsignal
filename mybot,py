import os
import requests
import time
import asyncio
from telegram import Bot
import logging
import random

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª
BOT_TOKEN = "ØªÙˆÚ©Ù†_Ø±Ø¨Ø§Øª_Ø®ÙˆØ¯Øª"  # Ø§Ø² @BotFather
CHAT_ID = "Ø¢ÛŒØ¯ÛŒ_Ú†Øª_Ø´Ù…Ø§"      # Ø§Ø² @userinfobot

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

bot = Bot(token=BOT_TOKEN)

async def send_alert(signal, k, d):
    """Ø§Ø±Ø³Ø§Ù„ Ø¢Ù„Ø§Ø±Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…"""
    if signal == "BUY":
        message = f"ğŸŸ¢ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯\nXAUUSD ØªØ§ÛŒÙ… Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡\nØ§Ø³ØªÙˆÚ©Ø§Ø³ØªÛŒÚ© Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´\nK: {k:.1f} - D: {d:.1f}"
    elif signal == "SELL":
        message = f"ğŸ”´ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´\nXAUUSD ØªØ§ÛŒÙ… Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡\nØ§Ø³ØªÙˆÚ©Ø§Ø³ØªÛŒÚ© Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯\nK: {k:.1f} - D: {d:.1f}"
    else:
        return False
    
    try:
        await bot.send_message(chat_id=CHAT_ID, text=message)
        logger.info(f"Ø¢Ù„Ø§Ø±Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {signal}")
        return True
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¢Ù„Ø§Ø±Ù…: {e}")
        return False

async def send_start_message():
    """Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹"""
    try:
        await bot.send_message(
            chat_id=CHAT_ID, 
            text="ğŸš€ Ø±Ø¨Ø§Øª Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø·Ù„Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯\nØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…: Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡\nØ§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±: Stochastic"
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹: {e}")

def check_stochastic_signal():
    """Ø¨Ø±Ø±Ø³ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø³ØªÙˆÚ©Ø§Ø³ØªÛŒÚ©"""
    # Ø¨Ø±Ø§ÛŒ Ø¯Ù…ÙˆØŒ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    k = random.randint(0, 100)
    d = random.randint(0, 100)
    
    signal = None
    if k <= 20 and d <= 25:  # Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´
        signal = "BUY"
        logger.info(f"Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯ - K: {k}, D: {d}")
    elif k >= 80 and d >= 75:  # Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯
        signal = "SELL" 
        logger.info(f"Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´ - K: {k}, D: {d}")
    else:
        logger.info(f"Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ - K: {k}, D: {d}")
    
    return signal, k, d

async def main():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ"""
    logger.info("ğŸ¤– Ø±Ø¨Ø§Øª Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø·Ù„Ø§ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯")
    
    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹
    await send_start_message()
    
    # Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ
    while True:
        try:
            signal, k, d = check_stochastic_signal()
            
            if signal:
                await send_alert(signal, k, d)
            
            # Ù…Ù†ØªØ¸Ø± Û± Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù…Ø§Ù† (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)
            logger.info("â³ Ù…Ù†ØªØ¸Ø± Ú†Ú© Ø¨Ø¹Ø¯ÛŒ...")
            await asyncio.sleep(60)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ: {e}")
            await asyncio.sleep(30)

if __name__ == "__main__":
    # Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
    asyncio.run(main())
